<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WMS Scanner ‚Äî MVP v1.4</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:16px;}
    .badge{display:inline-block;background:#111;color:#fff;border-radius:12px;padding:6px 10px;margin-bottom:8px;}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.05);}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;cursor:pointer;}
    input{padding:10px;border-radius:10px;border:1px solid #ccc;}
    video{width:100%;border-radius:12px;background:#000;}
    .muted{color:#666;}
    .ok{color:#0a8;}
    .err{color:#c33;}
    #log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:10px;max-height:260px;overflow:auto;}
  </style>
  <!-- ZXing –∏–∑ jsdelivr + onerror-–ª–æ–≥ -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"
          onerror="console.error('ZXing load error');"></script>
</head>
<body>
  <div class="badge">v1.4</div>
  <div class="muted">–ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç—Ç–æ ‚Äî JS –∑–∞–≥—Ä—É–∑–∏–ª—Å—è üëç</div>

  <div class="card">
    <div class="row">
      <label>API URL:</label>
      <input id="apiUrl" value="https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec" size="50"/>
    </div>
    <div class="row" style="margin-top:8px;">
      <label>API Key:</label>
      <input id="apiKey" value="Sklad_1507" size="20"/>
      <label>Device ID:</label>
      <input id="deviceId" value="android-01" size="14"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="cfgStatus" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button id="modePut">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</button>
      <button id="modePick">–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä</button>
      <span id="modeLabel" style="font-size:28px;font-weight:700;">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</span>
    </div>
  </div>

  <div class="card">
    <video id="preview" playsinline></video>
    <div class="row" style="margin-top:8px;">
      <button id="startCam">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã</button>
      <button id="stopCam">–°—Ç–æ–ø</button>
      <button id="torchBtn">–§–æ–Ω–∞—Ä–∏–∫</button>
      <button id="diagBtn">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–º–µ—Ä—ã</button>
      <button id="switchCamBtn">–ü—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞–º–µ—Ä—É</button>
      <button id="testClicks">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫</button>
    </div>
    <div id="scanInfo" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card" id="workArea"></div>

  <div class="card">
    <div style="font-weight:700;">–õ–æ–≥</div>
    <div id="log" class="muted"></div>
  </div>

  <script>
  // ===== –ª–æ–≥ =====
  const logBox = document.getElementById('log');
  function log(m){ const t=new Date().toLocaleTimeString('ru-RU'); logBox.textContent += `[${t}] ${m}\n`; logBox.scrollTop=logBox.scrollHeight; }
  window.onerror = (msg,src,line,col,err)=>{ log(`JS error: ${msg} @${line}:${col}`); if(err&&err.stack) log(String(err.stack)); };

  // ===== DOM =====
  const $ = s=>document.querySelector(s);
  const state = { mode:'put', stream:null, track:null, torch:false, devices:[], idx:-1, lastProduct:null, lastLocation:null,
                  useZXing:false, codeReader:null, useBarcodeDetector:false, detector:null };

  // ===== –∫–æ–Ω—Ñ–∏–≥ =====
  const DEFAULT_API_URL='https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec';
  const DEFAULT_API_KEY='Sklad_1507'; const DEFAULT_DEVICE='android-01';
  const cfg={ get url(){return localStorage.getItem('apiUrl')||DEFAULT_API_URL;}, set url(v){localStorage.setItem('apiUrl',v);},
              get key(){return localStorage.getItem('apiKey')||DEFAULT_API_KEY;}, set key(v){localStorage.setItem('apiKey',v);},
              get device(){return localStorage.getItem('deviceId')||DEFAULT_DEVICE;}, set device(v){localStorage.setItem('deviceId',v);} };
  function loadCfg(){ $('#apiUrl').value=cfg.url; $('#apiKey').value=cfg.key; $('#deviceId').value=cfg.device; log('–ö–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω.'); }
  $('#saveCfg').onclick=()=>{ cfg.url=$('#apiUrl').value.trim(); cfg.key=$('#apiKey').value.trim(); cfg.device=$('#deviceId').value.trim(); $('#cfgStatus').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(()=>$('#cfgStatus').textContent='',1200); log('–ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.'); };

  // ===== —Å–∞–º–æ—Ç–µ—Å—Ç –∫–Ω–æ–ø–æ–∫ =====
  $('#testClicks').onclick=()=>{ log('–¢–µ—Å—Ç: –∫–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ'); $('#scanInfo').textContent='–¢–µ—Å—Ç –∫–ª–∏–∫–æ–≤: –û–ö'; alert('–ö–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç üëç'); };

  // ===== –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞ =====
  (function initScanner(){
    try{
      if (window.ZXingBrowser && ZXingBrowser.BrowserMultiFormatReader){
        state.useZXing = true;
        state.codeReader = new ZXingBrowser.BrowserMultiFormatReader();
        log('ZXing –≥–æ—Ç–æ–≤.');
      } else if ('BarcodeDetector' in window){
        state.useBarcodeDetector = true;
        state.detector = new BarcodeDetector({ formats: ['qr_code'] });
        log('ZXing –Ω–µ—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º BarcodeDetector.');
      } else {
        log('–ù–µ—Ç –Ω–∏ ZXing, –Ω–∏ BarcodeDetector ‚Äî —Å–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
      }
    }catch(e){ log('initScanner error: '+e); }
  })();

  // ===== –∫–∞–º–µ—Ä–∞ =====
  async function stopCam(){ try{ if(state.stream) state.stream.getTracks().forEach(t=>t.stop()); }catch{} state.stream=null; state.track=null; state.torch=false; $('#scanInfo').textContent='–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'; log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.'); }
  async function listCameras(){ try{ if(!state.stream){ try{ const tmp=await navigator.mediaDevices.getUserMedia({video:true}); tmp.getTracks().forEach(t=>t.stop()); }catch{} } const devs=await navigator.mediaDevices.enumerateDevices(); state.devices=devs.filter(d=>d.kind==='videoinput'); log('–ö–∞–º–µ—Ä –Ω–∞–π–¥–µ–Ω–æ: '+state.devices.length); return state.devices; }catch(e){ log('enumerateDevices error: '+e.name+' '+e.message); return []; } }
  async function attachStream(stream,msg){ state.stream=stream; const v=$('#preview'); v.srcObject=stream; await v.play(); state.track=stream.getVideoTracks()[0]; $('#scanInfo').textContent=msg; log(msg); if(state.useZXing) scanLoopZXing(); else if(state.useBarcodeDetector) scanLoopBD(); }
  async function startByFacing(){ await stopCam(); try{ const s=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false }); await attachStream(s,'–ö–∞–º–µ—Ä–∞: environment'); return true; }catch(e){ log('getUserMedia environment error: '+e.name+' '+e.message); return false; } }
  async function startByDeviceIndex(i){ await stopCam(); if(!state.devices.length) await listCameras(); if(!state.devices.length){ $('#scanInfo').textContent='–ù–µ—Ç –∫–∞–º–µ—Ä'; return; } const dev=state.devices[i%state.devices.length]; try{ const s=await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact: dev.deviceId } }, audio:false }); state.idx=i; await attachStream(s,'–ö–∞–º–µ—Ä–∞: '+(dev.label||'–±–µ–∑ –∏–º–µ–Ω–∏')); }catch(e){ $('#scanInfo').textContent='–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: '+e.name; log('getUserMedia by deviceId error: '+e.name+' '+e.message); } }
  async function startCam(){ log('–ù–∞–∂–∞—Ç–∏–µ: –°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã.'); const ok=await startByFacing(); if(ok) return; const cams=await listCameras(); if(!cams.length){ $('#scanInfo').textContent='–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã/–Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'; log('–ù–µ—Ç –∫–∞–º–µ—Ä/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'); return; } await startByDeviceIndex(0); }
  async function switchCamera(){ log('–ù–∞–∂–∞—Ç–∏–µ: –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É.'); const cams=await listCameras(); if(!cams.length){ $('#scanInfo').textContent='–ù–µ—Ç –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è'; return; } state.idx=(state.idx+1)%cams.length; await startByDeviceIndex(state.idx); }
  async function toggleTorch(){ log('–ù–∞–∂–∞—Ç–∏–µ: –§–æ–Ω–∞—Ä–∏–∫.'); if(!state.track){ $('#scanInfo').textContent='–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ –∫–∞–º–µ—Ä—É'; return; } try{ const caps=state.track.getCapabilities?.(); if(!caps||!caps.torch){ $('#scanInfo').textContent='–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'; log('Torch not supported'); return; } state.torch=!state.torch; await state.track.applyConstraints({ advanced:[{ torch:state.torch }] }); $('#scanInfo').textContent=state.torch?'–§–æ–Ω–∞—Ä–∏–∫: –í–ö–õ':'–§–æ–Ω–∞—Ä–∏–∫: –í–´–ö–õ'; log('Torch '+(state.torch?'ON':'OFF')); }catch(e){ $('#scanInfo').textContent='Torch error: '+e.name; log('Torch error: '+e.name+' '+e.message); } }

  $('#startCam').onclick=startCam; $('#stopCam').onclick=stopCam; $('#torchBtn').onclick=toggleTorch; $('#diagBtn').onclick=async()=>{const isHttps=location.protocol==='https:'; const devs=await navigator.mediaDevices.enumerateDevices().catch(e=>{log('enumerateDevices: '+e.name);return[];}); const cams=(devs||[]).filter(d=>d.kind==='videoinput'); const s=`HTTPS:${isHttps?'–¥–∞':'–Ω–µ—Ç'} | –∫–∞–º–µ—Ä:${cams.length}`; $('#scanInfo').textContent=s; log(s);}; $('#switchCamBtn').onclick=switchCamera;

  // ===== —Å–∫–∞–Ω-—Ü–∏–∫–ª—ã =====
  async function scanLoopZXing(){ const v=$('#preview'); if(!v||!state.stream||!state.codeReader) return; try{ const res=await state.codeReader.decodeOnceFromVideoElement(v); if(res&&res.text){ log('QR: '+res.text); $('#scanInfo').textContent='QR: '+res.text; if(navigator.vibrate) navigator.vibrate(40); } }catch(_){} if(state.stream) requestAnimationFrame(scanLoopZXing); }
  async function scanLoopBD(){ const v=$('#preview'); if(!v||!state.stream||!state.detector) return; try{ const bit = await createImageBitmap(v); const barcodes = await state.detector.detect(bit); if(barcodes && barcodes.length){ const txt=barcodes[0].rawValue; log('QR: '+txt); $('#scanInfo').textContent='QR: '+txt; if(navigator.vibrate) navigator.vibrate(40); } }catch(_){} if(state.stream) requestAnimationFrame(scanLoopBD); }
  // helper for BarcodeDetector
  async function createImageBitmap(video){ const c=document.createElement('canvas'); c.width=video.videoWidth||640; c.height=video.videoHeight||480; const ctx=c.getContext('2d'); ctx.drawImage(video,0,0,c.width,c.height); return await (self.createImageBitmap? self.createImageBitmap(c): new Promise(r=>{const img=new Image(); img.onload=()=>r(img); img.src=c.toDataURL();})); }

  // ===== —Ä–µ–∂–∏–º—ã (—É–ø—Ä–æ—â–µ–Ω–æ) =====
  function setMode(m){ state.mode=m; $('#modeLabel').textContent=(m==='put')?'–†–∞–∑–º–µ—â–µ–Ω–∏–µ':'–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä'; $('#workArea').innerHTML=(m==='put')?'<div class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞, –∑–∞—Ç–µ–º QR –ø–æ–ª–∫–∏‚Ä¶</div>':'<div class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞ ‚Äî –ø–æ–∫–∞–∂—É –ø–æ–ª–∫–∏‚Ä¶</div>'; log('–†–µ–∂–∏–º: '+m); }
  $('#modePut').onclick=()=>setMode('put'); $('#modePick').onclick=()=>setMode('pick');

  // ===== init =====
  loadCfg(); setMode('put'); log('–ì–æ—Ç–æ–≤–æ. –ï—Å–ª–∏ ZXing –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º BarcodeDetector.');
  </script>
</body>
</html>
