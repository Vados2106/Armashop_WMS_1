<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WMS Scanner ‚Äî MVP v1.3 diag</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:16px;}
    .badge{display:inline-block;background:#111;color:#fff;border-radius:12px;padding:6px 10px;margin-bottom:8px;}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.05);}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;cursor:pointer;}
    input{padding:10px;border-radius:10px;border:1px solid #ccc;}
    video{width:100%;border-radius:12px;background:#000;}
    .muted{color:#666;}
    .ok{color:#0a8;}
    .err{color:#c33;}
    #log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:10px;max-height:260px;overflow:auto;}
  </style>
</head>
<body>
  <div class="badge">v1.3 diag</div>
  <div class="muted">–ï—Å–ª–∏ –≤–∏–¥–∏—à—å —ç—Ç–æ ‚Äî JS –∑–∞–≥—Ä—É–∑–∏–ª—Å—è üëç</div>

  <div class="card">
    <div class="row">
      <label>API URL:</label>
      <input id="apiUrl" value="https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec" size="50"/>
    </div>
    <div class="row" style="margin-top:8px;">
      <label>API Key:</label>
      <input id="apiKey" value="Sklad_1507" size="20"/>
      <label>Device ID:</label>
      <input id="deviceId" value="android-01" size="14"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="cfgStatus" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button id="modePut">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</button>
      <button id="modePick">–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä</button>
      <span id="modeLabel" style="font-size:28px;font-weight:700;">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</span>
    </div>
  </div>

  <div class="card">
    <video id="preview" playsinline></video>
    <div class="row" style="margin-top:8px;">
      <button id="startCam">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã</button>
      <button id="stopCam">–°—Ç–æ–ø</button>
      <button id="torchBtn">–§–æ–Ω–∞—Ä–∏–∫</button>
      <button id="diagBtn">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–º–µ—Ä—ã</button>
      <button id="switchCamBtn">–ü—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞–º–µ—Ä—É</button>
      <button id="testClicks">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫</button>
    </div>
    <div id="scanInfo" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card" id="workArea"></div>

  <div class="card">
    <div style="font-weight:700;">–õ–æ–≥</div>
    <div id="log" class="muted"></div>
  </div>

  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <script>
  // ===== –£—Ç–∏–ª–∏—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è =====
  const logBox = document.getElementById('log');
  function log(msg){ const time = new Date().toLocaleTimeString('ru-RU'); logBox.textContent += '['+time+'] '+msg+'\n'; logBox.scrollTop = logBox.scrollHeight; }
  window.onerror = function(msg, src, line, col, err){ log('JS error: '+msg+' @'+line+':'+col); if(err && err.stack){ log(String(err.stack)); } };

  const $ = s => document.querySelector(s);
  const state = { mode:'put', stream:null, track:null, torch:false, devices:[], idx:-1, lastProduct:null, lastLocation:null };
  const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec';
  const DEFAULT_API_KEY = 'Sklad_1507';
  const DEFAULT_DEVICE = 'android-01';

  const cfg = {
    get url(){ return localStorage.getItem('apiUrl') || DEFAULT_API_URL; },
    set url(v){ localStorage.setItem('apiUrl', v); },
    get key(){ return localStorage.getItem('apiKey') || DEFAULT_API_KEY; },
    set key(v){ localStorage.setItem('apiKey', v); },
    get device(){ return localStorage.getItem('deviceId') || DEFAULT_DEVICE; },
    set device(v){ localStorage.setItem('deviceId', v); }
  };

  function loadCfg(){
    $('#apiUrl').value = cfg.url;
    $('#apiKey').value = cfg.key;
    $('#deviceId').value = cfg.device;
    log('–ö–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω.');
  }

  $('#saveCfg').onclick = () => {
    cfg.url = $('#apiUrl').value.trim();
    cfg.key = $('#apiKey').value.trim();
    cfg.device = $('#deviceId').value.trim();
    $('#cfgStatus').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
    setTimeout(()=> $('#cfgStatus').textContent='', 1200);
    log('–ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');
  };

  // ===== –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ =====
  $('#testClicks').onclick = () => {
    log('–¢–µ—Å—Ç: –∫–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç ‚úÖ');
    $('#scanInfo').textContent = '–¢–µ—Å—Ç –∫–ª–∏–∫–æ–≤: –û–ö';
    alert('–ö–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç üëç');
  };

  // ===== –ö–∞–º–µ—Ä–∞ / ZXing =====
  const codeReader = new ZXingBrowser.BrowserMultiFormatReader();

  async function stopCam(){
    try{
      if(state.stream){ state.stream.getTracks().forEach(t => t.stop()); }
      state.stream = null; state.track = null; state.torch = false;
      $('#scanInfo').textContent = '–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
      log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.');
    }catch(e){ log('stopCam error: '+e); }
  }

  async function listCameras(){
    try{
      // –ß—Ç–æ–±—ã enumerateDevices –≤–µ—Ä–Ω—É–ª –º–µ—Ç–∫–∏ ‚Äî –Ω—É–∂–µ–Ω —Ö–æ—Ç—è –±—ã —Ä–∞–∑ getUserMedia
      if(!state.stream){
        try{
          const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
          tmp.getTracks().forEach(t=>t.stop());
        }catch(e){ /* –∏–≥–Ω–æ—Ä, –ø—Ä–æ—Å—Ç–æ —á—Ç–æ–±—ã —Å–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ */ }
      }
      const devs = await navigator.mediaDevices.enumerateDevices();
      state.devices = devs.filter(d => d.kind === 'videoinput');
      log('–ö–∞–º–µ—Ä –Ω–∞–π–¥–µ–Ω–æ: '+state.devices.length);
      return state.devices;
    }catch(e){
      log('enumerateDevices error: '+e.name+' '+e.message);
      return [];
    }
  }

  async function startByFacing(){
    await stopCam();
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ ideal:'environment' } }, audio:false });
      state.stream = stream;
      const video = $('#preview'); video.srcObject = stream; await video.play();
      state.track = stream.getVideoTracks()[0];
      $('#scanInfo').textContent = '–ö–∞–º–µ—Ä–∞: environment';
      log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ (environment).');
      scanLoop();
      return true;
    }catch(e){
      log('getUserMedia environment error: '+e.name+' '+e.message);
      return false;
    }
  }

  async function startByDeviceIndex(i){
    await stopCam();
    const dev = state.devices[i % state.devices.length];
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact: dev.deviceId } }, audio:false });
      state.stream = stream;
      const video = $('#preview'); video.srcObject = stream; await video.play();
      state.track = stream.getVideoTracks()[0];
      state.idx = i;
      $('#scanInfo').textContent = '–ö–∞–º–µ—Ä–∞: '+(dev.label || '–±–µ–∑ –∏–º–µ–Ω–∏');
      log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ –ø–æ deviceId: '+(dev.label || dev.deviceId));
      scanLoop();
    }catch(e){
      log('getUserMedia by deviceId error: '+e.name+' '+e.message);
      $('#scanInfo').textContent = '–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –∫–∞–º–µ—Ä—ã: '+e.name;
    }
  }

  async function startCam(){
    log('–ù–∞–∂–∞—Ç–∏–µ: –°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã.');
    const ok = await startByFacing();
    if(ok) return;
    const cams = await listCameras();
    if(!cams.length){
      $('#scanInfo').textContent = '–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω';
      log('–ù–µ—Ç –∫–∞–º–µ—Ä –∏–ª–∏ –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
      return;
    }
    await startByDeviceIndex(0);
  }

  async function switchCamera(){
    log('–ù–∞–∂–∞—Ç–∏–µ: –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É.');
    const cams = await listCameras();
    if(!cams.length){ $('#scanInfo').textContent='–ù–µ—Ç –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è'; return; }
    state.idx = (state.idx + 1) % cams.length;
    await startByDeviceIndex(state.idx);
  }

  async function toggleTorch(){
    log('–ù–∞–∂–∞—Ç–∏–µ: –§–æ–Ω–∞—Ä–∏–∫.');
    if(!state.track){ $('#scanInfo').textContent='–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ –∫–∞–º–µ—Ä—É'; return; }
    try{
      const caps = state.track.getCapabilities ? state.track.getCapabilities() : null;
      if(!caps || !caps.torch){ $('#scanInfo').textContent='–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'; log('Torch not supported.'); return; }
      state.torch = !state.torch;
      await state.track.applyConstraints({ advanced:[{ torch: state.torch }] });
      $('#scanInfo').textContent = state.torch ? '–§–æ–Ω–∞—Ä–∏–∫: –í–ö–õ' : '–§–æ–Ω–∞—Ä–∏–∫: –í–´–ö–õ';
      log('Torch '+(state.torch?'ON':'OFF')+'.');
    }catch(e){
      log('Torch error: '+e.name+' '+e.message);
      $('#scanInfo').textContent = 'Torch error: '+e.name;
    }
  }

  async function diag(){
    log('–ù–∞–∂–∞—Ç–∏–µ: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.');
    const arr = [];
    const isHttps = location.protocol === 'https:';
    arr.push('Origin: '+location.origin);
    arr.push('HTTPS: '+(isHttps?'–¥–∞':'–Ω–µ—Ç ‚Äî –∫–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞'));
    try{
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d => d.kind === 'videoinput');
      arr.push('–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: '+cams.length);
      cams.forEach((c,i)=> arr.push('#'+i+' '+(c.label || '–∫–∞–º–µ—Ä–∞ –±–µ–∑ –∏–º–µ–Ω–∏')));
    }catch(e){
      arr.push('enumerateDevices error: '+e.name+' '+e.message);
    }
    $('#scanInfo').textContent = arr.join(' | ');
    log(arr.join(' | '));
  }

  $('#startCam').onclick = startCam;
  $('#stopCam').onclick = stopCam;
  $('#torchBtn').onclick = toggleTorch;
  $('#diagBtn').onclick = diag;
  $('#switchCamBtn').onclick = switchCamera;

  // ===== –°–∫–∞–Ω-—Ü–∏–∫–ª =====
  async function scanLoop(){
    const video = $('#preview');
    if(!video || !state.stream) return;
    try{
      const res = await codeReader.decodeOnceFromVideoElement(video);
      if(res && res.text){
        log('QR: '+res.text);
        $('#scanInfo').textContent = 'QR: '+res.text;
        if(navigator.vibrate) navigator.vibrate(40);
      }
    }catch(_e){
      // ignore ‚Äî —Ü–∏–∫–ª –∂–¥—ë—Ç —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
    }
    if(state.stream) requestAnimationFrame(scanLoop);
  }

  // ===== –†–µ–∂–∏–º—ã –∏ —Ä–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å (–º–∏–Ω–∏–º—É–º –¥–ª—è —Ç–µ—Å—Ç–∞) =====
  function setMode(m){
    state.mode = m;
    $('#modeLabel').textContent = (m === 'put') ? '–†–∞–∑–º–µ—â–µ–Ω–∏–µ' : '–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä';
    $('#workArea').innerHTML = (m === 'put')
      ? '<div class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞, –ø–æ—Ç–æ–º QR –ø–æ–ª–∫–∏ –∏ –≤–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ‚Ä¶</div>'
      : '<div class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞, –¥–∞–ª—å—à–µ –ø–æ–∫–∞–∂—É –ø–æ–ª–∫–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∏‚Ä¶</div>';
    log('–†–µ–∂–∏–º: '+m);
  }
  $('#modePut').onclick = ()=> setMode('put');
  $('#modePick').onclick = ()=> setMode('pick');

  // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
  loadCfg();
  setMode('put');
  log('–ì–æ—Ç–æ–≤–æ. –ñ–º–∏ "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫" ‚Üí "–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–º–µ—Ä—ã" ‚Üí "–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã".');
  </script>
</body>
</html>
