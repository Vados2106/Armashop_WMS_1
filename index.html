<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WMS Scanner ‚Äî v1.8 step-by-step</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:16px;}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    button{padding:10px 14px;border:1px solid #ccc;border-radius:10px;cursor:pointer;}
    input{padding:10px;border:1px solid #ccc;border-radius:10px;}
    video{width:100%;background:#000;border-radius:12px;}
    .muted{color:#666;}
    .ok{color:#0a8;}
    .err{color:#c33;}
    #log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:10px;max-height:240px;overflow:auto;}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px;align-items:center;}
  </style>
</head>
<body>
  <h3>üì¶ WMS Scanner ‚Äî <span class="ok">v1.8 step-by-step</span></h3>
  <div class="muted">–ü–æ—Ä—è–¥–æ–∫: –°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã ‚Üí –¢–æ–≤–∞—Ä ‚Üí –ü–æ–ª–∫–∞ ‚Üí –í–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üí –†–∞–∑–º–µ—â–µ–Ω–∏–µ.</div>

  <!-- –ö–æ–Ω—Ñ–∏–≥ -->
  <div class="card">
    <div class="row">
      <label>API URL:</label>
      <input id="apiUrl" value="https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec" size="50"/>
    </div>
    <div class="row" style="margin-top:8px;">
      <label>API Key:</label>
      <input id="apiKey" value="Sklad_1507" size="20"/>
      <label>Device ID:</label>
      <input id="deviceId" value="android-01" size="14"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="cfgStatus" class="muted"></span>
    </div>
  </div>

  <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π -->
  <div class="card">
    <div class="row">
      <button id="startCam">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã (640√ó480@15)</button>
      <button id="stopCam">–°—Ç–æ–ø</button>
      <button id="switchCam">–î—Ä—É–≥–∞—è –∫–∞–º–µ—Ä–∞</button>
      <span id="camStatus" class="muted"></span>
    </div>
    <video id="preview" playsinline></video>
  </div>

  <!-- –ü–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å -->
  <div class="card">
    <div class="row">
      <button id="scanProduct">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
      <button id="scanLocation">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–∫—É</button>
      <button id="resetFlow">–°–±—Ä–æ—Å</button>
      <span id="flowHint" class="muted"></span>
    </div>

    <div class="kv" style="margin-top:10px;">
      <div>–¢–æ–≤–∞—Ä (SKU):</div><div id="skuView" class="muted">‚Äî</div>
      <div>–ü–æ–ª–∫–∞ (LOC):</div><div id="locView" class="muted">‚Äî</div>
      <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</div>
      <div>
        <input id="qty" type="number" step="1" value="1" style="width:120px;"/>
        <button class="qbtn" data-d="+1">+1</button>
        <button class="qbtn" data-d="+5">+5</button>
        <button class="qbtn" data-d="-1">‚àí1</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="doPut">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</button>
      <span id="opStatus" class="muted"></span>
    </div>
  </div>

  <!-- –õ–æ–≥ -->
  <div class="card">
    <div style="font-weight:700;">–õ–æ–≥</div>
    <div id="log" class="muted"></div>
  </div>

<script>
/* ===== –ª–æ–≥ ===== */
const logBox=document.getElementById('log');
function log(m){const t=new Date().toLocaleTimeString('ru-RU');logBox.textContent+=`[${t}] ${m}\n`;logBox.scrollTop=logBox.scrollHeight;}
window.onerror=(msg,src,l,c,e)=>{log(`JS error: ${msg} @${l}:${c}`);if(e&&e.stack)log(String(e.stack));};

/* ===== DOM ===== */
const $=s=>document.querySelector(s);
const statusCam=$('#camStatus'), statusOp=$('#opStatus'), flowHint=$('#flowHint');
const skuView=$('#skuView'), locView=$('#locView');

/* ===== —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
let stream=null, track=null, devices=[], idx=-1;
let detector=null, detectTimer=null;
const state={ stage:'idle', sku:null, loc:null };
const DETECT_INTERVAL_MS=300;

/* ===== –∫–æ–Ω—Ñ–∏–≥/API ===== */
const DEFAULT_API_URL='https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec';
const DEFAULT_API_KEY='Sklad_1507'; const DEFAULT_DEVICE='android-01';
const cfg={ get url(){return localStorage.getItem('apiUrl')||DEFAULT_API_URL;}, set url(v){localStorage.setItem('apiUrl',v);},
            get key(){return localStorage.getItem('apiKey')||DEFAULT_API_KEY;}, set key(v){localStorage.setItem('apiKey',v);},
            get device(){return localStorage.getItem('deviceId')||DEFAULT_DEVICE;}, set device(v){localStorage.setItem('deviceId',v);} };
function loadCfg(){ $('#apiUrl').value=cfg.url; $('#apiKey').value=cfg.key; $('#deviceId').value=cfg.device; }
$('#saveCfg').onclick=()=>{ cfg.url=$('#apiUrl').value.trim(); cfg.key=$('#apiKey').value.trim(); cfg.device=$('#deviceId').value.trim(); $('#cfgStatus').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(()=>$('#cfgStatus').textContent='',1200); };

async function apiPost(path, body){
  const r = await fetch(cfg.url, {
    method: 'POST',
    // –í–ê–ñ–ù–û: text/plain ‚Üí simple request, –±–µ–∑ OPTIONS
    headers: {'Content-Type': 'text/plain'},
    body: JSON.stringify({ path, apiKey: cfg.key, ...body })
  });
  const j = await r.json().catch(()=>({error:'Bad JSON'}));
  if(!r.ok) throw new Error(j.error || ('HTTP '+r.status));
  return j;
}


/* ===== –∫–∞–º–µ—Ä–∞ ===== */
async function stopCam(){ try{ if(stream){stream.getTracks().forEach(t=>t.stop());} }catch(_){}
  stream=null; track=null; statusCam.textContent='–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'; log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.'); stopDetect(); }
async function listCameras(){ try{ if(!stream){ try{ const tmp=await navigator.mediaDevices.getUserMedia({video:true}); tmp.getTracks().forEach(t=>t.stop()); }catch(_){ } }
  const devs=await navigator.mediaDevices.enumerateDevices(); devices=devs.filter(d=>d.kind==='videoinput'); log('–ö–∞–º–µ—Ä –Ω–∞–π–¥–µ–Ω–æ: '+devices.length); return devices;
} catch(e){ log('enumerateDevices error: '+e.name+' '+e.message); return []; } }
async function attach(s,msg){ stream=s; const v=$('#preview'); v.srcObject=stream; await v.play(); track=stream.getVideoTracks()[0]; statusCam.textContent=msg; log(msg); }
async function startByFacing(){ await stopCam(); try{
  const s=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'}, width:{ideal:640,max:640}, height:{ideal:480,max:480}, frameRate:{ideal:15,max:15} }, audio:false });
  await attach(s,'–ö–∞–º–µ—Ä–∞: environment (640√ó480@15)'); return true;
} catch(e){ log('env error: '+e.name+' '+e.message); return false; } }
async function startByIndex(i){ await stopCam(); if(!devices.length) await listCameras(); if(!devices.length){ statusCam.textContent='–ù–µ—Ç –∫–∞–º–µ—Ä'; return; }
  const dev=devices[i%devices.length]; try{
    const s=await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{exact:dev.deviceId}, width:{ideal:640,max:640}, height:{ideal:480,max:480}, frameRate:{ideal:15,max:15} }, audio:false });
    idx=i; await attach(s,'–ö–∞–º–µ—Ä–∞: '+(dev.label||'–±–µ–∑ –∏–º–µ–Ω–∏')+' (640√ó480@15)');
  } catch(e){ statusCam.textContent='–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: '+e.name; log('by device error: '+e.name+' '+e.message); } }
async function startCam(){ log('–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã‚Ä¶'); const ok=await startByFacing(); if(ok) return; const cams=await listCameras(); if(!cams.length){ statusCam.textContent='–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã/–Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'; return; } await startByIndex(0); }
async function switchCam(){ const cams=await listCameras(); if(!cams.length){ statusCam.textContent='–ù–µ—Ç –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è'; return; } idx=(idx+1)%cams.length; await startByIndex(idx); }

document.getElementById('startCam').onclick=startCam;
document.getElementById('stopCam').onclick=stopCam;
document.getElementById('switchCam').onclick=switchCam;

/* ===== BarcodeDetector (—â–∞–¥—è—â–∏–π) ===== */
async function ensureDetector(){
  if(detector) return true;
  if('BarcodeDetector' in window){
    try{ detector=new BarcodeDetector({formats:['qr_code']}); log('BarcodeDetector –≥–æ—Ç–æ–≤.'); return true; }
    catch(e){ log('BD init error: '+e.name+' '+e.message); }
  }
  flowHint.textContent='–°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç BarcodeDetector)'; return false;
}
function stopDetect(){ if(detectTimer){ clearInterval(detectTimer); detectTimer=null; } }
function startDetect(stage){
  if(!stream){ flowHint.textContent='–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—Ç—É–π –∫–∞–º–µ—Ä—É'; return; }
  ensureDetector().then(ok=>{
    if(!ok) return;
    state.stage=stage;
    if(stage==='product'){ flowHint.textContent='–ñ–¥—É QR —Ç–æ–≤–∞—Ä–∞‚Ä¶ (INV1|P;...)'; }
    if(stage==='location'){ flowHint.textContent='–ñ–¥—É QR –ø–æ–ª–∫–∏‚Ä¶ (INV1|L;...)'; }
    stopDetect();
    detectTimer=setInterval(()=> detectOnce(), DETECT_INTERVAL_MS);
  });
}

async function detectOnce(){
  try{
    const v=$('#preview');
    const c=document.createElement('canvas'); c.width=320; c.height=240;
    const ctx=c.getContext('2d'); ctx.drawImage(v,0,0,c.width,c.height);
    const bmp=await (window.createImageBitmap?window.createImageBitmap(c):new Promise(res=>{const img=new Image();img.onload=()=>res(img);img.src=c.toDataURL();}));
    const codes=await detector.detect(bmp);
    if(!codes || !codes.length) return;
    const txt=codes[0].rawValue||'';
    onScan(txt);
  }catch(_){ /* ignore */ }
}

/* ===== –ø–∞—Ä—Å–µ—Ä QR (–∫–∞–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) ===== */
function parseQr(payload){
  if(!payload || typeof payload!=='string') return null;
  if(!payload.startsWith('INV1|')) return null;
  const rest=payload.substring(5); // –ø–æ—Å–ª–µ INV1|
  const parts=rest.split(';').filter(Boolean);
  const head=parts.shift();
  const kv={}; parts.forEach(s=>{ const m=s.split('='); if(m.length===2) kv[m[0]]=m[1]; });
  // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞: –∫–æ—Ä–æ—Ç–∫–∏–π (P;SKU) –∏ —Å –∫–ª—é—á–æ–º (P;SKU=XXXX)
  if(head==='P'){ return {type:'product', sku: kv.SKU || parts[0] || null}; }
  if(head==='L'){ return {type:'location', loc: kv.LOC || parts[0] || null}; }
  return null;
}

/* ===== –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–∞ –ø–æ —ç—Ç–∞–ø–∞–º ===== */
function onScan(txt){
  if(navigator.vibrate) navigator.vibrate(20);
  const meta=parseQr(txt);
  if(state.stage==='product'){
    if(!meta || meta.type!=='product' || !meta.sku){ flowHint.textContent='–≠—Ç–æ –Ω–µ QR —Ç–æ–≤–∞—Ä–∞. –ñ–¥—É INV1|P;...'; return; }
    state.sku=meta.sku; skuView.textContent=state.sku;
    stopDetect(); state.stage='idle';
    flowHint.textContent='–¢–æ–≤–∞—Ä —Å—á–∏—Ç–∞–Ω. –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–∫—É¬ª.';
    log('–°—á–∏—Ç–∞–Ω —Ç–æ–≤–∞—Ä: '+state.sku);
  } else if(state.stage==='location'){
    if(!meta || meta.type!=='location' || !meta.loc){ flowHint.textContent='–≠—Ç–æ –Ω–µ QR –ø–æ–ª–∫–∏. –ñ–¥—É INV1|L;...'; return; }
    state.loc=meta.loc; locView.textContent=state.loc;
    stopDetect(); state.stage='idle';
    flowHint.textContent='–ü–æ–ª–∫–∞ —Å—á–∏—Ç–∞–Ω–∞. –í–≤–µ–¥–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–∂–º–∏ ¬´–†–∞–∑–º–µ—â–µ–Ω–∏–µ¬ª.';
    log('–°—á–∏—Ç–∞–Ω–∞ –ø–æ–ª–∫–∞: '+state.loc);
  } else {
    // –≤–Ω–µ —ç—Ç–∞–ø–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–¥—Ä–µ–±–µ–∑–≥–∞¬ª
  }
}

/* ===== –∫–Ω–æ–ø–∫–∏ —ç—Ç–∞–ø–æ–≤ ===== */
document.getElementById('scanProduct').onclick=()=> startDetect('product');
document.getElementById('scanLocation').onclick=()=> startDetect('location');
document.getElementById('resetFlow').onclick=resetFlow;
function resetFlow(){
  state.stage='idle'; state.sku=null; state.loc=null; skuView.textContent='‚Äî'; locView.textContent='‚Äî';
  stopDetect(); statusOp.textContent=''; flowHint.textContent='–ì–æ—Ç–æ–≤–æ. –°–Ω–∞—á–∞–ª–∞ ‚Äî ¬´–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä¬ª.';
}

/* ===== –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ ===== */
document.querySelectorAll('.qbtn').forEach(b=> b.onclick=()=>{
  const d=Number(b.getAttribute('data-d')); const el=$('#qty'); el.value=Math.max(0, Number(el.value||0)+d);
});
document.getElementById('doPut').onclick=async()=>{
  const qty=Number($('#qty').value||0);
  if(!state.sku){ statusOp.textContent='–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π —Ç–æ–≤–∞—Ä'; return; }
  if(!state.loc){ statusOp.textContent='–°–Ω–∞—á–∞–ª–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π –ø–æ–ª–∫—É'; return; }
  if(qty<=0){ statusOp.textContent='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0'; return; }
  try{
    statusOp.textContent='–û—Ç–ø—Ä–∞–≤–ª—è—é‚Ä¶';
    const r=await apiPost('move',{ sku:state.sku, loc_code:state.loc, qty_delta:qty, action:'putaway', user:'worker@local', device_id:(localStorage.getItem('deviceId')||'android-01'), op_id:(crypto.randomUUID?crypto.randomUUID():String(Date.now())), note:'' });
    statusOp.innerHTML=`<span class="ok">–û–ö. –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ ${state.loc}: <b>${r.new_qty}</b></span>`;
    log(`PUT ${state.sku} -> ${state.loc} x${qty}: new=${r.new_qty}`);
    // –∞–≤—Ç–æ-—Ä–µ—Å–µ—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
    resetFlow();
  }catch(e){
    statusOp.innerHTML=`<span class="err">–û—à–∏–±–∫–∞: ${e.message}</span>`;
    log('PUT error: '+e.message);
  }
};

/* ===== init ===== */
loadCfg();
resetFlow();
log('–ì–æ—Ç–æ–≤–æ. –°—Ç–∞—Ä—Ç—É–π –∫–∞–º–µ—Ä—É ‚Üí –¢–æ–≤–∞—Ä ‚Üí –ü–æ–ª–∫–∞ ‚Üí –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üí –†–∞–∑–º–µ—â–µ–Ω–∏–µ.');
</script>
</body>
</html>
