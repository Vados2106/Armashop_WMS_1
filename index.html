<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WMS Scanner ‚Äî v1.8.2 step-by-step (GET move)</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:16px;}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    button{padding:10px 14px;border:1px solid #ccc;border-radius:10px;cursor:pointer;}
    input{padding:10px;border:1px solid #ccc;border-radius:10px;}
    video{width:100%;background:#000;border-radius:12px;}
    .muted{color:#666;}
    .ok{color:#0a8;}
    .err{color:#c33;}
    #log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:10px;max-height:240px;overflow:auto;}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px;align-items:center;}
  </style>
</head>
<body>
  <h3>üì¶ WMS Scanner ‚Äî <span class="ok">v1.8.2</span> (GET move)</h3>
  <div class="muted">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã ‚Üí –¢–æ–≤–∞—Ä ‚Üí –ü–æ–ª–∫–∞ ‚Üí –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Üí –†–∞–∑–º–µ—â–µ–Ω–∏–µ.</div>

  <div class="card">
    <div class="row">
      <label>API URL:</label>
      <input id="apiUrl" value="https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec" size="50"/>
    </div>
    <div class="row" style="margin-top:8px;">
      <label>API Key:</label>
      <input id="apiKey" value="Sklad_1507" size="20"/>
      <label>Device ID:</label>
      <input id="deviceId" value="android-01" size="14"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="cfgStatus" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button id="startCam">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã (640√ó480@15)</button>
      <button id="stopCam">–°—Ç–æ–ø</button>
      <button id="switchCam">–î—Ä—É–≥–∞—è –∫–∞–º–µ—Ä–∞</button>
      <span id="camStatus" class="muted"></span>
    </div>
    <video id="preview" playsinline></video>
  </div>

  <div class="card">
    <div class="row">
      <button id="scanProduct">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
      <button id="scanLocation">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–∫—É</button>
      <button id="resetFlow">–°–±—Ä–æ—Å</button>
      <span id="flowHint" class="muted"></span>
    </div>

    <div class="kv" style="margin-top:10px;">
      <div>–¢–æ–≤–∞—Ä (SKU):</div><div id="skuView" class="muted">‚Äî</div>
      <div>–ü–æ–ª–∫–∞ (LOC):</div><div id="locView" class="muted">‚Äî</div>
      <div>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</div>
      <div>
        <input id="qty" type="number" step="1" value="1" style="width:120px;"/>
        <button class="qbtn" data-d="+1">+1</button>
        <button class="qbtn" data-d="+5">+5</button>
        <button class="qbtn" data-d="-1">‚àí1</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="doPut">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</button>
      <span id="opStatus" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:700;">–õ–æ–≥</div>
    <div id="log" class="muted"></div>
  </div>

<script>
const logBox=document.getElementById('log');
function log(m){const t=new Date().toLocaleTimeString('ru-RU');logBox.textContent+=`[${t}] ${m}\n`;logBox.scrollTop=logBox.scrollHeight;}
window.onerror=(msg,src,l,c,e)=>{log(`JS error: ${msg} @${l}:${c}`);if(e&&e.stack)log(String(e.stack));};

const $=s=>document.querySelector(s);
const statusCam=$('#camStatus'), statusOp=$('#opStatus'), flowHint=$('#flowHint');
const skuView=$('#skuView'), locView=$('#locView');

let stream=null, track=null, devices=[], idx=-1;
let detector=null, detectTimer=null;
const state={ stage:'idle', sku:null, loc:null };
const DETECT_INTERVAL_MS=300;

/* === –∫–æ–Ω—Ñ–∏–≥ === */
const DEFAULT_API_URL='https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec';
const DEFAULT_API_KEY='Sklad_1507'; const DEFAULT_DEVICE='android-01';
const cfg={ get url(){return localStorage.getItem('apiUrl')||DEFAULT_API_URL;}, set url(v){localStorage.setItem('apiUrl',v);},
            get key(){return localStorage.getItem('apiKey')||DEFAULT_API_KEY;}, set key(v){localStorage.setItem('apiKey',v);},
            get device(){return localStorage.getItem('deviceId')||DEFAULT_DEVICE;}, set device(v){localStorage.setItem('deviceId',v);} };
function loadCfg(){ $('#apiUrl').value=cfg.url; $('#apiKey').value=cfg.key; $('#deviceId').value=cfg.device; }
$('#saveCfg').onclick=()=>{ cfg.url=$('#apiUrl').value.trim(); cfg.key=$('#apiKey').value.trim(); cfg.device=$('#deviceId').value.trim(); $('#cfgStatus').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
