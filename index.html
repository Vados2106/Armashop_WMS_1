<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WMS Scanner MVP</title>
  <style>
    body{ font-family: system-ui, Arial, sans-serif; margin:0; padding:16px; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card{ border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    .big{ font-size:28px; font-weight:700; }
    button{ padding:10px 14px; border-radius:10px; border:1px solid #ccc; cursor:pointer; }
    input, select{ padding:10px; border-radius:10px; border:1px solid #ccc; }
    video{ width:100%; border-radius:12px; background:#000; }
    .muted{ color:#666; }
    .ok{ color:#0a8; }
    .err{ color:#c33; }
    .qtypad button{ min-width:60px; font-size:18px; }
    .grid{ display:grid; grid-template-columns:1fr auto; gap:8px; }
  </style>
</head>
<body>
  <h2>üì¶ WMS Scanner ‚Äî MVP</h2>

  <div class="card">
    <div class="row">
      <label>API URL:</label>
      <input id="apiUrl" value="https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec" size="50" />
    </div>
    <div class="row" style="margin-top:8px;">
      <label>API Key:</label>
      <input id="apiKey" value="Sklad_1507" size="30" />
      <label>Device ID:</label>
      <input id="deviceId" value="android-01" size="20" />
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="cfgStatus" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <button id="modePut">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</button>
      <button id="modePick">–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä</button>
      <span id="modeLabel" class="big">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</span>
    </div>
  </div>

  <div class="card">
    <video id="preview" playsinline></video>
    <div class="row" style="margin-top:8px;">
      <button id="startCam">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã</button>
      <button id="stopCam">–°—Ç–æ–ø</button>
      <button id="torchBtn">–§–æ–Ω–∞—Ä–∏–∫</button>
      <button id="diagBtn">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–º–µ—Ä—ã</button>
      <button id="switchCamBtn">–ü—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞–º–µ—Ä—É</button>
      <span id="scanInfo" class="muted"></span>
    </div>
    <span id="diagInfo" class="muted" style="display:block;margin-top:6px;"></span>
    <div id="lastScan" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="card" id="workArea"></div>

  <script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
  <script>
  const $ = s=>document.querySelector(s);
  const state = { mode:'put', lastProduct:null, lastLocation:null, stream:null, track:null, torchOn:false };

  // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —É–∂–µ —Å —Ç–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
  const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec';
  const DEFAULT_API_KEY = 'Sklad_1507';
  const DEFAULT_DEVICE = 'android-01';

  const cfg = {
    get url(){ return localStorage.getItem('apiUrl') || DEFAULT_API_URL; },
    set url(v){ localStorage.setItem('apiUrl', v); },
    get key(){ return localStorage.getItem('apiKey') || DEFAULT_API_KEY; },
    set key(v){ localStorage.setItem('apiKey', v); },
    get device(){ return localStorage.getItem('deviceId') || DEFAULT_DEVICE; },
    set device(v){ localStorage.setItem('deviceId', v); },
  };

  function loadCfg(){ $('#apiUrl').value=cfg.url; $('#apiKey').value=cfg.key; $('#deviceId').value=cfg.device; }
  $('#saveCfg').onclick = ()=>{ cfg.url=$('#apiUrl').value.trim(); cfg.key=$('#apiKey').value.trim(); cfg.device=$('#deviceId').value.trim(); $('#cfgStatus').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'; setTimeout(()=> $('#cfgStatus').textContent='', 1500); };
  loadCfg();

  // === –ö–∞–º–µ—Ä–∞ / ZXing + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ===
  const codeReader = new ZXingBrowser.BrowserMultiFormatReader();
  let deviceList = []; let currentDeviceIndex = -1;

  async function startCam(){
    await stopCam();
    try{
      const res = await navigator.mediaDevices.getUserMedia({ video: { facingMode:{ ideal:'environment' } } });
      state.stream = res; const video=$('#preview'); video.srcObject=res; await video.play(); state.track=res.getVideoTracks()[0];
      scanLoop(); $('#scanInfo').textContent='–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ (environment)';
    }catch(err){ $('#scanInfo').textContent='–ù–µ —É–¥–∞–ª–æ—Å—å environment: '+err.name; await startCamFallback(); }
  }

  async function startCamFallback(){
    const cams = await listCameras(); if(!cams.length){ $('#scanInfo').textContent='–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (HTTPS/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è)'; return; }
    currentDeviceIndex = 0; await startByDeviceIndex(currentDeviceIndex);
  }

  async function listCameras(){
    try{ if(!state.stream){ await navigator.mediaDevices.getUserMedia({ video:true }); await stopCam(); }
      const devices = await navigator.mediaDevices.enumerateDevices(); deviceList = devices.filter(d=>d.kind==='videoinput'); return deviceList;
    }catch(err){ $('#diagInfo').textContent='enumerateDevices error: '+err; return []; }
  }

  async function startByDeviceIndex(i){
    await stopCam(); if(!deviceList.length){ await listCameras(); } if(!deviceList.length){ $('#scanInfo').textContent='–ù–µ—Ç –∫–∞–º–µ—Ä'; return; }
    const dev = deviceList[i % deviceList.length];
    try{ const res = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: dev.deviceId } } });
      state.stream=res; const video=$('#preview'); video.srcObject=res; await video.play(); state.track=res.getVideoTracks()[0];
      $('#scanInfo').textContent='–ö–∞–º–µ—Ä–∞: '+(dev.label||'–±–µ–∑ –∏–º–µ–Ω–∏'); scanLoop();
    }catch(err){ $('#scanInfo').textContent='–°—Ç–∞—Ä—Ç –ø–æ deviceId –Ω–µ —É–¥–∞–ª—Å—è: '+err.name; }
  }

  async function switchCamera(){ if(!deviceList.length){ await listCameras(); } if(!deviceList.length){ $('#scanInfo').textContent='–ù–µ—Ç –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è'; return; } currentDeviceIndex=(currentDeviceIndex+1)%deviceList.length; await startByDeviceIndex(currentDeviceIndex); }

  function diag(){ const isHttps = location.protocol==='https:'; const info=[]; info.push('Origin: '+location.origin); info.push('HTTPS: '+(isHttps?'–¥–∞':'–Ω–µ—Ç ‚Äî –∫–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞'));
    navigator.mediaDevices.enumerateDevices().then(devs=>{ const cams=devs.filter(d=>d.kind==='videoinput'); if(!cams.length){ info.push('–ö–∞–º–µ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω'); } else { info.push('–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: '+cams.length); cams.forEach((c,i)=> info.push(`#${i} ${c.label||'–∫–∞–º–µ—Ä–∞ –±–µ–∑ –∏–º–µ–Ω–∏'}`)); } $('#diagInfo').textContent=info.join('
'); }).catch(err=>{ info.push('enumerateDevices error: '+err); $('#diagInfo').textContent=info.join('
'); }); } else { info.push('–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: '+cams.length); cams.forEach((c,i)=> info.push(`#${i} ${c.label||'–∫–∞–º–µ—Ä–∞ –±–µ–∑ –∏–º–µ–Ω–∏'}`)); } $('#diagInfo').textContent=info.join('
'); }).catch(err=>{ info.push('enumerateDevices error: '+err); $('#diagInfo').textContent=info.join('
'); }); }

  async function stopCam(){ if(state.stream){ state.stream.getTracks().forEach(t=>t.stop()); } state.stream=null; state.track=null; state.torchOn=false; $('#scanInfo').textContent='–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'; }
  async function toggleTorch(){ try{ if(!state.track) return; const caps=state.track.getCapabilities?.(); if(!caps||!caps.torch){ $('#scanInfo').textContent='–§–æ–Ω–∞—Ä–∏–∫ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'; return; } state.torchOn=!state.torchOn; await state.track.applyConstraints({ advanced:[{ torch:state.torchOn }] }); $('#scanInfo').textContent= state.torchOn?'–§–æ–Ω–∞—Ä–∏–∫: –í–ö–õ':'–§–æ–Ω–∞—Ä–∏–∫: –í–´–ö–õ'; }catch(err){ $('#scanInfo').textContent='Torch error: '+err; } }

  $('#startCam').onclick = startCam; $('#stopCam').onclick = stopCam; $('#torchBtn').onclick = toggleTorch; $('#diagBtn').onclick = diag; $('#switchCamBtn').onclick = switchCamera;

  async function scanLoop(){ const video=$('#preview'); if(!video||!state.stream) return; try{ const res=await codeReader.decodeOnceFromVideoElement(video); if(res&&res.text){ onScan(res.text); } }catch(_){} if(state.stream) requestAnimationFrame(scanLoop); }

  function setMode(m){ state.mode=m; $('#modeLabel').textContent=(m==='put')?'–†–∞–∑–º–µ—â–µ–Ω–∏–µ':'–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä'; state.lastProduct=null; state.lastLocation=null; renderWork(); }
  $('#modePut').onclick = ()=> setMode('put'); $('#modePick').onclick = ()=> setMode('pick');
  function vibro(){ if(navigator.vibrate) navigator.vibrate(40); }

  function onScan(txt){ $('#lastScan').textContent='QR: '+txt; if(txt.startsWith('INV1|P;')) return onProductQR(txt); if(txt.startsWith('INV1|L;')) return onLocationQR(txt); vibro(); }

  async function apiGet(path, params){ const url=new URL(cfg.url); url.searchParams.set('path', path); url.searchParams.set('key', cfg.key); Object.entries(params||{}).forEach(([k,v])=> url.searchParams.set(k,v)); const r=await fetch(url.toString(), {method:'GET'}); const j=await r.json(); if(!r.ok) throw new Error(j.error||('HTTP '+r.status)); return j; }
  async function apiPost(path, body){ const r=await fetch(cfg.url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path, apiKey: cfg.key, ...body })}); const j=await r.json(); if(!r.ok) throw new Error(j.error||('HTTP '+r.status)); return j; }

  async function onProductQR(code){ try{ const p=await apiGet('product',{code}); state.lastProduct=p; vibro(); renderWork(); }catch(err){ $('#scanInfo').textContent='–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω: '+err.message; } }
  async function onLocationQR(code){ try{ const l=await apiGet('location',{code}); state.lastLocation=l; vibro(); renderWork(); }catch(err){ $('#scanInfo').textContent='–ü–æ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: '+err.message; } }

  function renderWork(){ const w=$('#workArea'); w.innerHTML=''; if(state.mode==='put'){ const p=state.lastProduct, l=state.lastLocation; const pHtml=p?`<div>SKU: <b>${p.sku}</b> ‚Äî ${p.name}</div>`:'<div class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞‚Ä¶</div>'; const lHtml=l?`<div>–ü–æ–ª–∫–∞: <b>${l.loc_code}</b></div>`:'<div class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR –ø–æ–ª–∫–∏‚Ä¶</div>'; w.insertAdjacentHTML('beforeend', `<div class="grid">${pHtml}${lHtml}</div>`); if(p&&l){ w.insertAdjacentHTML('beforeend', `<div style="margin-top:12px;"><label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label> <input id="qty" type="number" step="1" value="1" style="width:120px;" /> <div class="row qtypad" style="margin-top:8px;"><button data-q="1">+1</button><button data-q="5">+5</button><button data-q="10">+10</button><button id="putBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div><div id="resPut" class="muted" style="margin-top:6px;"></div></div>`); w.querySelectorAll('.qtypad button[data-q]').forEach(b=> b.onclick=()=>{ const add=Number(b.getAttribute('data-q')); const el=$('#qty'); el.value=Math.max(0, Number(el.value||0)+add); }); w.querySelector('#putBtn').onclick=postPutaway; } } else { const p=state.lastProduct; const pHtml=p?`<div>SKU: <b>${p.sku}</b> ‚Äî ${p.name}</div>`:'<div class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞‚Ä¶</div>'; w.insertAdjacentHTML('beforeend', `<div>${pHtml}</div>`); if(p){ loadWhere(p.sku); } } }

  async function postPutaway(){ const p=state.lastProduct, l=state.lastLocation; const qty=Number($('#qty').value||0); if(!p||!l||qty<=0){ $('#resPut').textContent='–ü—Ä–æ–≤–µ—Ä—å –¥–∞–Ω–Ω—ã–µ'; return; } try{ const r=await apiPost('move',{ sku:p.sku, loc_code:l.loc_code, qty_delta:qty, action:'putaway', user:'worker@local', device_id:cfg.device, op_id:crypto.randomUUID(), note:'' }); $('#resPut').innerHTML=`<span class="ok">–û–ö. –ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ ${l.loc_code}: <b>${r.new_qty}</b></span>`; vibro(); }catch(err){ $('#resPut').innerHTML=`<span class="err">–û—à–∏–±–∫–∞: ${err.message}</span>`; } }

  async function loadWhere(sku){ const w=$('#workArea'); const box=document.createElement('div'); box.className='card'; box.innerHTML='<div class="muted">–ó–∞–≥—Ä—É–∂–∞—é –æ—Å—Ç–∞—Ç–∫–∏‚Ä¶</div>'; w.appendChild(box); try{ const r=await apiGet('where',{sku}); if(!r.locations||!r.locations.length){ box.innerHTML='<div class="muted">–û—Å—Ç–∞—Ç–∫–æ–≤ –Ω–µ—Ç</div>'; return; } const list=r.locations.map(x=>`<div class="row"><div style=\"min-width:160px;\">–ü–æ–ª–∫–∞: <b>${x.loc_code}</b></div><div>–û—Å—Ç–∞—Ç–æ–∫: <b>${x.qty}</b></div><button data-loc=\"${x.loc_code}\">–û—Ç–æ–±—Ä–∞—Ç—å‚Ä¶</button></div>`).join(''); box.innerHTML=list; box.querySelectorAll('button[data-loc]').forEach(btn=> btn.onclick=()=> showPickDialog(sku, btn.getAttribute('data-loc'))); }catch(err){ box.innerHTML=`<span class="err">–û—à–∏–±–∫–∞: ${err.message}</span>`; } }

  function showPickDialog(sku,loc){ const w=$('#workArea'); const dia=document.createElement('div'); dia.className='card'; dia.innerHTML=`<div>–û—Ç–±–æ—Ä —Å <b>${loc}</b> –¥–ª—è SKU <b>${sku}</b></div><div style=\"margin-top:8px;\"><label>–°–ø–∏—Å–∞—Ç—å:</label><input id=\"qtyPick\" type=\"number\" step=\"1\" value=\"1\" style=\"width:120px;\"/><div class=\"row qtypad\" style=\"margin-top:8px;\"><button data-q=\"1\">+1</button><button data-q=\"5\">+5</button><button data-q=\"10\">+10</button><button id=\"pickBtn\">–°–ø–∏—Å–∞—Ç—å</button></div><div id=\"resPick\" class=\"muted\" style=\"margin-top:6px;\"></div></div>`; w.appendChild(dia); dia.querySelectorAll('.qtypad button[data-q]').forEach(b=> b.onclick=()=>{ const add=Number(b.getAttribute('data-q')); const el=dia.querySelector('#qtyPick'); el.value=Math.max(0, Number(el.value||0)+add); }); dia.querySelector('#pickBtn').onclick=async ()=>{ const qty=Number(dia.querySelector('#qtyPick').value||0); if(qty<=0){ dia.querySelector('#resPick').textContent='–£–∫–∞–∂–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ'; return; } try{ const r=await apiPost('move',{ sku, loc_code:loc, qty_delta:-Math.abs(qty), action:'pick', user:'worker@local', device_id:cfg.device, op_id:crypto.randomUUID(), note:'' }); dia.querySelector('#resPick').innerHTML=`<span class=\"ok\">–û–ö. –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ ${loc}: <b>${r.new_qty}</b></span>`; vibro(); }catch(err){ dia.querySelector('#resPick').innerHTML=`<span class=\"err\">–û—à–∏–±–∫–∞: ${err.message}</span>`; } };
  }

  setMode('put');
  </script>
</body>
</html>
