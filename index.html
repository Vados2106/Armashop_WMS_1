<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WMS Scanner ‚Äî v1.5 light</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:16px;}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    button{padding:10px 14px;border:1px solid #ccc;border-radius:10px;cursor:pointer;}
    video{width:100%;background:#000;border-radius:12px;}
    .muted{color:#666;}
    #log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:10px;max-height:220px;overflow:auto;}
  </style>
</head>
<body>
  <h3>üì¶ WMS Scanner ‚Äî v1.5 light (low-res)</h3>
  <div class="muted">–®–∞–≥–∏: –°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã ‚Üí –í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ ‚Üí –°–∫–∞–Ω.</div>

  <div class="card">
    <video id="preview" playsinline></video>
    <div class="row" style="margin-top:8px;">
      <button id="startCam">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã (640√ó480, 15fps)</button>
      <button id="stopCam">–°—Ç–æ–ø</button>
      <button id="switchCam">–î—Ä—É–≥–∞—è –∫–∞–º–µ—Ä–∞</button>
    </div>
    <div class="row" style="margin-top:8px;">
      <button id="startDetect">–í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</button>
      <button id="stopDetect">–í—ã–∫–ª—é—á–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</button>
    </div>
    <div id="status" class="muted" style="margin-top:6px;"></div>
  </div>

  <div class="card">
    <div style="font-weight:700;">–õ–æ–≥</div>
    <div id="log" class="muted"></div>
  </div>

<script>
const logBox = document.getElementById('log');
function log(m){ const t=new Date().toLocaleTimeString('ru-RU'); logBox.textContent += `[${t}] ${m}\n`; logBox.scrollTop=logBox.scrollHeight; }
window.onerror=(msg,src,l,c,e)=>{log(`JS error: ${msg} @${l}:${c}`); if(e&&e.stack) log(String(e.stack));};
const $=s=>document.querySelector(s);
const statusEl=$('#status');

let stream=null, track=null, devices=[], idx=-1;
let detector=null, detectOn=false, detectLoopHandle=null;

async function stopCam(){
  try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); } }catch(_){}
  stream=null; track=null; statusEl.textContent='–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞'; log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.');
}

async function listCameras(){
  try{
    if(!stream){
      try{ const tmp=await navigator.mediaDevices.getUserMedia({video:true}); tmp.getTracks().forEach(t=>t.stop()); }catch(_){}
    }
    const devs=await navigator.mediaDevices.enumerateDevices();
    devices=devs.filter(d=>d.kind==='videoinput'); log('–ö–∞–º–µ—Ä –Ω–∞–π–¥–µ–Ω–æ: '+devices.length);
    return devices;
  }catch(e){ log('enumerateDevices error: '+e.name+' '+e.message); return []; }
}

async function startByFacing(){
  await stopCam();
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video:{
        facingMode:{ideal:'environment'},
        width:{ideal:640, max:640},
        height:{ideal:480, max:480},
        frameRate:{ideal:15, max:15}
      },
      audio:false
    });
    await attach(s, '–ö–∞–º–µ—Ä–∞: environment (640√ó480@15)');
    return true;
  }catch(e){ log('getUserMedia env error: '+e.name+' '+e.message); return false; }
}

async function startByIndex(i){
  await stopCam();
  if(!devices.length) await listCameras();
  if(!devices.length){ statusEl.textContent='–ù–µ—Ç –∫–∞–º–µ—Ä'; return; }
  const dev=devices[i%devices.length];
  try{
    const s=await navigator.mediaDevices.getUserMedia({
      video:{
        deviceId:{exact:dev.deviceId},
        width:{ideal:640, max:640},
        height:{ideal:480, max:480},
        frameRate:{ideal:15, max:15}
      },
      audio:false
    });
    idx=i;
    await attach(s, '–ö–∞–º–µ—Ä–∞: '+(dev.label||'–±–µ–∑ –∏–º–µ–Ω–∏')+' (640√ó480@15)');
  }catch(e){ statusEl.textContent='–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: '+e.name; log('by device error: '+e.name+' '+e.message); }
}

async function attach(s,msg){
  stream=s;
  const v=$('#preview'); v.srcObject=stream; await v.play();
  track=stream.getVideoTracks()[0];
  statusEl.textContent=msg; log(msg);
}

async function startCam(){
  log('–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã‚Ä¶');
  const ok=await startByFacing();
  if(ok) return;
  const cams=await listCameras();
  if(!cams.length){ statusEl.textContent='–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã/–Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è'; return; }
  await startByIndex(0);
}

async function switchCam(){
  const cams=await listCameras();
  if(!cams.length){ statusEl.textContent='–ù–µ—Ç –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è'; return; }
  idx=(idx+1)%cams.length;
  await startByIndex(idx);
}

// === –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ, –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ===
async function ensureDetector(){
  if(detector) return true;
  if('BarcodeDetector' in window){
    try{ detector = new BarcodeDetector({formats:['qr_code']}); log('BarcodeDetector –≥–æ—Ç–æ–≤.'); return true; }
    catch(e){ log('BD init error: '+e.name+' '+e.message); }
  }
  statusEl.textContent='–°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç BarcodeDetector)'; 
  log('–ù–µ—Ç BarcodeDetector. –ú–æ–∂–Ω–æ –ø–æ–∑–∂–µ –≤–µ—Ä–Ω—É—Ç—å ZXing.');
  return false;
}

async function detectOnce(){
  if(!stream) return;
  const v=$('#preview');
  // —Ä–∏—Å—É–µ–º –º–∞–ª–µ–Ω—å–∫–∏–π –∫–∞–¥—Ä, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É
  const c=document.createElement('canvas');
  c.width=320; c.height=240;
  const ctx=c.getContext('2d');
  ctx.drawImage(v,0,0,c.width,c.height);
  const bitmap = await createImageBitmap(c);
  const codes = await detector.detect(bitmap);
  if(codes && codes.length){
    const txt=codes[0].rawValue;
    statusEl.textContent='QR: '+txt;
    log('QR: '+txt);
    if(navigator.vibrate) navigator.vibrate(30);
  }
}

async function startDetect(){
  if(!stream){ statusEl.textContent='–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ –∫–∞–º–µ—Ä—É'; return; }
  const ok=await ensureDetector(); if(!ok) return;
  if(detectOn) return;
  detectOn=true; log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: –í–ö–õ');
  // —Ç–∞–π–º–µ—Ä —Ä–∞–∑ –≤ 300–º—Å ‚Äî –ª–µ–≥—á–µ –¥–ª—è –¥–µ–≤–∞–π—Å–∞
  detectLoopHandle = setInterval(()=>{ detectOnce().catch(()=>{}); }, 300);
  statusEl.textContent='–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ';
}

function stopDetect(){
  if(detectLoopHandle) clearInterval(detectLoopHandle);
  detectLoopHandle=null; detectOn=false;
  statusEl.textContent='–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ';
  log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: –í–´–ö–õ');
}

async function createImageBitmap(canvas){
  // polyfill –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
  if(window.createImageBitmap) return await window.createImageBitmap(canvas);
  return new Promise(res=>{ const img=new Image(); img.onload=()=>res(img); img.src=canvas.toDataURL(); });
}

// === Wire ===
document.getElementById('startCam').onclick=startCam;
document.getElementById('stopCam').onclick=async()=>{ stopDetect(); await stopCam(); };
document.getElementById('switchCam').onclick=switchCam;
document.getElementById('startDetect').onclick=startDetect;
document.getElementById('stopDetect').onclick=stopDetect;

// === Page visibility: –∞–≤—Ç–æ—Å—Ç–æ–ø –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ stopDetect(); stopCam(); } });

log('–ì–æ—Ç–æ–≤–æ. –°—Ç–∞—Ä—Ç—É–π –∫–∞–º–µ—Ä—É ‚Üí –ø–æ—Ç–æ–º –≤–∫–ª—é—á–∞–π —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ.');
</script>
</body>
</html>
