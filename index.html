<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WMS Scanner ‚Äî v1.6 (put/pick + API)</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:16px;}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    button{padding:10px 14px;border:1px solid #ccc;border-radius:10px;cursor:pointer;}
    input{padding:10px;border:1px solid #ccc;border-radius:10px;}
    video{width:100%;background:#000;border-radius:12px;}
    .muted{color:#666;}
    .ok{color:#0a8;}
    .err{color:#c33;}
    #log{white-space:pre-wrap;background:#fafafa;border:1px dashed #ccc;border-radius:10px;padding:10px;max-height:220px;overflow:auto;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  </style>
</head>
<body>
  <h3>üì¶ WMS Scanner ‚Äî v1.6</h3>
  <div class="muted">–ü–æ—Ç–æ–∫ 640√ó480@15, –¥–µ—Ç–µ–∫—Ç–æ—Ä –ø–æ —Ç–∞–π–º–µ—Ä—É. –°–Ω–∞—á–∞–ª–∞ ‚Äî —Å—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã.</div>

  <!-- –ö–æ–Ω—Ñ–∏–≥ -->
  <div class="card">
    <div class="row">
      <label>API URL:</label>
      <input id="apiUrl" value="https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec" size="50"/>
    </div>
    <div class="row" style="margin-top:8px;">
      <label>API Key:</label>
      <input id="apiKey" value="Sklad_1507" size="20"/>
      <label>Device ID:</label>
      <input id="deviceId" value="android-01" size="14"/>
      <button id="saveCfg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="cfgStatus" class="muted"></span>
    </div>
  </div>

  <!-- –†–µ–∂–∏–º—ã -->
  <div class="card">
    <div class="row">
      <button id="modePut">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</button>
      <button id="modePick">–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä</button>
      <span id="modeLabel" style="font-size:22px;font-weight:700;">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</span>
    </div>
  </div>

  <!-- –ö–∞–º–µ—Ä–∞ -->
  <div class="card">
    <video id="preview" playsinline></video>
    <div class="row" style="margin-top:8px;">
      <button id="startCam">–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã (640√ó480@15)</button>
      <button id="stopCam">–°—Ç–æ–ø</button>
      <button id="switchCam">–î—Ä—É–≥–∞—è –∫–∞–º–µ—Ä–∞</button>
      <button id="startDetect">–í–∫–ª—é—á–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</button>
      <button id="stopDetect">–í—ã–∫–ª—é—á–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ</button>
    </div>
    <div id="status" class="muted" style="margin-top:6px;"></div>
  </div>

  <!-- –†–∞–±–æ—Ç–∞ -->
  <div class="card" id="workArea"></div>

  <!-- –õ–æ–≥ -->
  <div class="card">
    <div style="font-weight:700;">–õ–æ–≥</div>
    <div id="log" class="muted"></div>
  </div>

<script>
/* ===== —É—Ç–∏–ª—ã ===== */
const logBox=document.getElementById('log');
function log(m){const t=new Date().toLocaleTimeString('ru-RU');logBox.textContent+=`[${t}] ${m}\n`;logBox.scrollTop=logBox.scrollHeight;}
window.onerror=(msg,src,l,c,e)=>{log(`JS error: ${msg} @${l}:${c}`);if(e&&e.stack)log(String(e.stack));};
const $=s=>document.querySelector(s);
const statusEl=$('#status');

/* ===== —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===== */
let stream=null, track=null, devices=[], idx=-1;
let detector=null, detectOn=false, detectLoopHandle=null;
const state={ mode:'put', product:null, location:null };

/* ===== –∫–æ–Ω—Ñ–∏–≥ ===== */
const DEFAULT_API_URL='https://script.google.com/macros/s/AKfycbzRi65nCYMc8uqQAW1ujUtzEpg9SIsRfsKebnSy9TzfqJQIVnPBHECXw4V1LUGxzzclgA/exec';
const DEFAULT_API_KEY='Sklad_1507'; const DEFAULT_DEVICE='android-01';
const cfg={ get url(){return localStorage.getItem('apiUrl')||DEFAULT_API_URL;}, set url(v){localStorage.setItem('apiUrl',v);},
            get key(){return localStorage.getItem('apiKey')||DEFAULT_API_KEY;}, set key(v){localStorage.setItem('apiKey',v);},
            get device(){return localStorage.getItem('deviceId')||DEFAULT_DEVICE;}, set device(v){localStorage.setItem('deviceId',v);} };
function loadCfg(){$('#apiUrl').value=cfg.url;$('#apiKey').value=cfg.key;$('#deviceId').value=cfg.device;log('–ö–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω.');}
$('#saveCfg').onclick=()=>{cfg.url=$('#apiUrl').value.trim();cfg.key=$('#apiKey').value.trim();cfg.device=$('#deviceId').value.trim();$('#cfgStatus').textContent='–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';setTimeout(()=>$('#cfgStatus').textContent='',1200);log('–ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω.');};
loadCfg();

/* ===== API ===== */
async function apiGet(path, params){
  const url=new URL(cfg.url);
  url.searchParams.set('path', path); url.searchParams.set('key', cfg.key);
  Object.entries(params||{}).forEach(([k,v])=> url.searchParams.set(k, v));
  const r=await fetch(url.toString(), {method:'GET'}); const j=await r.json();
  if(!r.ok) throw new Error(j.error||('HTTP '+r.status)); return j;
}
async function apiPost(path, body){
  const r=await fetch(cfg.url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path,apiKey:cfg.key,...body})});
  const j=await r.json(); if(!r.ok) throw new Error(j.error||('HTTP '+r.status)); return j;
}

/* ===== –∫–∞–º–µ—Ä–∞ ===== */
async function stopCam(){try{if(stream){stream.getTracks().forEach(t=>t.stop());}}catch(_){}
  stream=null;track=null;statusEl.textContent='–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.');}
async function listCameras(){try{if(!stream){try{const tmp=await navigator.mediaDevices.getUserMedia({video:true});tmp.getTracks().forEach(t=>t.stop());}catch(_){}}const devs=await navigator.mediaDevices.enumerateDevices();devices=devs.filter(d=>d.kind==='videoinput');log('–ö–∞–º–µ—Ä –Ω–∞–π–¥–µ–Ω–æ: '+devices.length);return devices;}catch(e){log('enumerateDevices error: '+e.name+' '+e.message);return[];}}
async function attach(s,msg){stream=s;const v=$('#preview');v.srcObject=stream;await v.play();track=stream.getVideoTracks()[0];statusEl.textContent=msg;log(msg);}
async function startByFacing(){await stopCam();try{const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:640,max:640},height:{ideal:480,max:480},frameRate:{ideal:15,max:15}},audio:false});await attach(s,'–ö–∞–º–µ—Ä–∞: environment (640√ó480@15)');return true;}catch(e){log('env error: '+e.name+' '+e.message);return false;}}
async function startByIndex(i){await stopCam();if(!devices.length)await listCameras();if(!devices.length){statusEl.textContent='–ù–µ—Ç –∫–∞–º–µ—Ä';return;}
  const dev=devices[i%devices.length];try{const s=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:dev.deviceId},width:{ideal:640,max:640},height:{ideal:480,max:480},frameRate:{ideal:15,max:15}},audio:false});idx=i;await attach(s,'–ö–∞–º–µ—Ä–∞: '+(dev.label||'–±–µ–∑ –∏–º–µ–Ω–∏')+' (640√ó480@15)');}catch(e){statusEl.textContent='–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞: '+e.name;log('by device error: '+e.name+' '+e.message);}}
async function startCam(){log('–°—Ç–∞—Ä—Ç –∫–∞–º–µ—Ä—ã‚Ä¶');const ok=await startByFacing();if(ok)return;const cams=await listCameras();if(!cams.length){statusEl.textContent='–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã/–Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è';return;}await startByIndex(0);}
async function switchCam(){const cams=await listCameras();if(!cams.length){statusEl.textContent='–ù–µ—Ç –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è';return;}idx=(idx+1)%cams.length;await startByIndex(idx);}

/* ===== —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ (BarcodeDetector, —â–∞–¥—è—â–∏–π —Ä–µ–∂–∏–º) ===== */
async function ensureDetector(){if(detector) return true; if('BarcodeDetector'in window){try{detector=new BarcodeDetector({formats:['qr_code']});log('BarcodeDetector –≥–æ—Ç–æ–≤.');return true;}catch(e){log('BD init error: '+e.name+' '+e.message);}}
  statusEl.textContent='–°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';log('–ù–µ—Ç BarcodeDetector.');return false;}
async function detectOnce(){if(!stream) return;const v=$('#preview');const c=document.createElement('canvas');c.width=320;c.height=240;const ctx=c.getContext('2d');ctx.drawImage(v,0,0,c.width,c.height);
  const bmp=await (window.createImageBitmap?window.createImageBitmap(c):new Promise(res=>{const img=new Image();img.onload=()=>res(img);img.src=c.toDataURL();}));
  const codes=await detector.detect(bmp); if(codes&&codes.length){const txt=codes[0].rawValue; onScan(txt);}}
async function startDetect(){if(!stream){statusEl.textContent='–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ –∫–∞–º–µ—Ä—É';return;}const ok=await ensureDetector();if(!ok)return;if(detectOn)return;detectOn=true;log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: –í–ö–õ');detectLoopHandle=setInterval(()=>{detectOnce().catch(()=>{});},300);statusEl.textContent='–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ';}
function stopDetect(){if(detectLoopHandle)clearInterval(detectLoopHandle);detectLoopHandle=null;detectOn=false;statusEl.textContent='–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≤—ã–∫–ª—é—á–µ–Ω–æ';log('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ: –í–´–ö–õ');}

/* ===== –æ–±—Ä–∞–±–æ—Ç–∫–∞ QR ===== */
function onScan(txt){
  statusEl.textContent='QR: '+txt; log('QR: '+txt); if(navigator.vibrate) navigator.vibrate(20);
  if(txt.startsWith('INV1|P;')){ loadProduct(txt); return; }
  if(txt.startsWith('INV1|L;')){ loadLocation(txt); return; }
}

/* ===== —Ä–∞–±–æ—Ç–∞ —Å API: —Ç–æ–≤–∞—Ä/–ø–æ–ª–∫–∞/–æ—Å—Ç–∞—Ç–∫–∏/–¥–≤–∏–∂–µ–Ω–∏–µ ===== */
async function loadProduct(code){try{const p=await apiGet('product',{code});state.product=p;renderWork();}catch(e){statusEl.textContent='–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω: '+e.message;}}
async function loadLocation(code){try{const l=await apiGet('location',{code});state.location=l;renderWork();}catch(e){statusEl.textContent='–ü–æ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: '+e.message;}}
async function loadWhere(sku){try{const r=await apiGet('where',{sku});return r.locations||[];}catch(e){statusEl.textContent='–û—à–∏–±–∫–∞ where: '+e.message;return[];}}
async function postMove({sku,loc,delta,action}){try{const r=await apiPost('move',{sku:sku,loc_code:loc,qty_delta:delta,action:action,user:'worker@local',device_id:cfg.device,op_id:crypto.randomUUID(),note:''});return r;}catch(e){throw e;}}

/* ===== UI —Ä–µ–∂–∏–º–æ–≤ ===== */
function setMode(m){state.mode=m;$('#modeLabel').textContent=(m==='put')?'–†–∞–∑–º–µ—â–µ–Ω–∏–µ':'–ü–æ–∏—Å–∫/–û—Ç–±–æ—Ä';state.product=null;state.location=null;renderWork();}
$('#modePut').onclick=()=>setMode('put'); $('#modePick').onclick=()=>setMode('pick');

function renderWork(){
  const w=$('#workArea'); w.innerHTML='';
  if(state.mode==='put'){
    const p=state.product, l=state.location;
    w.insertAdjacentHTML('beforeend', `<div class="grid">
      <div>${p?`SKU: <b>${p.sku}</b> ‚Äî ${p.name}`:'<span class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞‚Ä¶</span>'}</div>
      <div>${l?`–ü–æ–ª–∫–∞: <b>${l.loc_code}</b>`:'<span class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR –ø–æ–ª–∫–∏‚Ä¶</span>'}</div>
    </div>`);
    if(p&&l){
      w.insertAdjacentHTML('beforeend', `<div style="margin-top:10px;">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
        <input id="qtyPut" type="number" step="1" value="1" style="width:120px;"/>
        <button id="doPut">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <span id="resPut" class="muted"></span>
      </div>`);
      $('#doPut').onclick=async()=>{const q=Number($('#qtyPut').value||0); if(q<=0){$('#resPut').textContent='–£–∫–∞–∂–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ';return;}
        try{const r=await postMove({sku:p.sku,loc:l.loc_code,delta:q,action:'putaway'}); $('#resPut').innerHTML=`<span class="ok">–û–ö. –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ ${l.loc_code}: <b>${r.new_qty}</b></span>`; }catch(e){$('#resPut').innerHTML=`<span class="err">–û—à–∏–±–∫–∞: ${e.message}</span>`;}};
    }
  } else {
    const p=state.product;
    w.insertAdjacentHTML('beforeend', `<div>${p?`SKU: <b>${p.sku}</b> ‚Äî ${p.name}`:'<span class="muted">–°–∫–∞–Ω–∏—Ä—É–π QR —Ç–æ–≤–∞—Ä–∞‚Ä¶</span>'}</div>`);
    if(p){ // –ø–æ–¥–≥—Ä—É–∑–∏–º –º–µ—Å—Ç–∞
      const box=document.createElement('div'); box.className='card'; box.innerHTML='<div class="muted">–ó–∞–≥—Ä—É–∂–∞—é –æ—Å—Ç–∞—Ç–∫–∏‚Ä¶</div>'; w.appendChild(box);
      loadWhere(p.sku).then(list=>{
        if(!list.length){box.innerHTML='<div class="muted">–û—Å—Ç–∞—Ç–∫–æ–≤ –Ω–µ—Ç</div>';return;}
        box.innerHTML=list.map(x=>`<div class="row"><div style="min-width:140px;">–ü–æ–ª–∫–∞: <b>${x.loc_code}</b></div><div>–û—Å—Ç–∞—Ç–æ–∫: <b>${x.qty}</b></div><button data-loc="${x.loc_code}">–°–ø–∏—Å–∞—Ç—å‚Ä¶</button></div>`).join('');
        box.querySelectorAll('button[data-loc]').forEach(btn=> btn.onclick=()=>showPickDialog(p.sku, btn.getAttribute('data-loc')));
      });
    }
  }
}
function showPickDialog(sku,loc){
  const w=$('#workArea'); const dia=document.createElement('div'); dia.className='card';
  dia.innerHTML=`<div>–û—Ç–±–æ—Ä —Å <b>${loc}</b> –¥–ª—è SKU <b>${sku}</b></div>
    <div style="margin-top:8px;">
      <label>–°–ø–∏—Å–∞—Ç—å:</label>
      <input id="qtyPick" type="number" step="1" value="1" style="width:120px;"/>
      <button id="doPick">–°–ø–∏—Å–∞—Ç—å</button>
      <span id="resPick" class="muted"></span>
    </div>`;
  w.appendChild(dia);
  dia.querySelector('#doPick').onclick=async()=>{const q=Number(dia.querySelector('#qtyPick').value||0); if(q<=0){dia.querySelector('#resPick').textContent='–£–∫–∞–∂–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ';return;}
    try{const r=await postMove({sku,loc,delta:-Math.abs(q),action:'pick'}); dia.querySelector('#resPick').innerHTML=`<span class="ok">–û–ö. –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ ${loc}: <b>${r.new_qty}</b></span>`;}catch(e){dia.querySelector('#resPick').innerHTML=`<span class="err">–û—à–∏–±–∫–∞: ${e.message}</span>`;}};
}

/* ===== wire ===== */
document.getElementById('startCam').onclick=startCam;
document.getElementById('stopCam').onclick=async()=>{stopDetect();await stopCam();};
document.getElementById('switchCam').onclick=switchCam;
document.getElementById('startDetect').onclick=startDetect;
document.getElementById('stopDetect').onclick=stopDetect;
document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ stopDetect(); stopCam(); } });

/* ===== init ===== */
setMode('put'); log('–ì–æ—Ç–æ–≤–æ. –°—Ç–∞—Ä—Ç—É–π –∫–∞–º–µ—Ä—É ‚Üí –≤–∫–ª—é—á–∞–π
